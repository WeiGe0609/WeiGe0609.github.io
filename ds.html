<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek Chat - é»‘å®¢ç»ˆç«¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }
        
        body {
            background-color: #0a0a0a;
            color: #00ff00;
            line-height: 1.6;
            overflow-x: hidden;
            padding: 20px;
            position: relative;
            min-height: 100vh;
        }
        
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(0, 255, 0, 0.03) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(0, 255, 0, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
            z-index: -1;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            min-height: 95vh;
        }
        
        header {
            text-align: center;
            padding: 10px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #00ff00;
            position: relative;
        }
        
        h1 {
            font-size: 2.5rem;
            text-shadow: 0 0 10px #00ff00;
            letter-spacing: 2px;
        }
        
        .header-subtitle {
            font-size: 0.9rem;
            color: #00cc00;
            margin-top: 5px;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            gap: 20px;
        }
        
        .sidebar {
            width: 250px;
            border: 1px solid #00ff00;
            padding: 15px;
            border-radius: 5px;
            background-color: rgba(0, 20, 0, 0.2);
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid #00ff00;
            border-radius: 5px;
            overflow: hidden;
            background-color: rgba(0, 10, 0, 0.1);
        }
        
        .chat-header {
            padding: 10px 15px;
            background-color: rgba(0, 30, 0, 0.3);
            border-bottom: 1px solid #00ff00;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            max-height: 60vh;
            display: flex;
            flex-direction: column;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            animation: fadeIn 0.3s ease-in;
            position: relative;
            max-width: 80%;
            display: flex;
            flex-direction: column;
        }
        
        .user-message {
            background-color: rgba(0, 40, 0, 0.3);
            border: 1px solid #00ff00;
            align-self: flex-end;
            margin-left: auto;
        }
        
        .assistant-message {
            background-color: rgba(0, 20, 0, 0.2);
            border: 1px solid #00cc00;
            align-self: flex-start;
            margin-right: auto;
        }
        
        .message-header {
            font-weight: bold;
            margin-bottom: 5px;
            color: #00cc00;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .message-content {
            white-space: pre-wrap;
            line-height: 1.5;
        }
        
        .input-area {
            padding: 15px;
            border-top: 1px solid #00ff00;
            background-color: rgba(0, 20, 0, 0.2);
        }
        
        .api-key-container {
            margin-bottom: 15px;
        }
        
        input, select, button, textarea {
            background-color: #001100;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 10px;
            width: 100%;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 5px #00ff00;
        }
        
        button {
            cursor: pointer;
            transition: all 0.3s;
            background-color: #002200;
        }
        
        button:hover {
            background-color: #004400;
            box-shadow: 0 0 8px #00ff00;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
        }
        
        .btn-group button {
            flex: 1;
        }
        
        .conversation-item {
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #003300;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .conversation-item:hover {
            background-color: #002200;
        }
        
        .conversation-item.active {
            background-color: #003300;
            border-color: #00ff00;
        }
        
        .timestamp {
            font-size: 0.7rem;
            color: #009900;
        }
        
        .model-selector {
            margin-bottom: 15px;
        }
        
        .typing-indicator {
            display: inline-block;
            overflow: hidden;
        }
        
        .typing-indicator::after {
            content: "â–‹â–‹";
            animation: blink 1s infinite;
            color: #00ff00;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .glitch-effect {
            text-shadow: 2px 0 #00ff00, -2px 0 #000, 0 0 5px #00ff00;
            animation: glitch 2s infinite;
        }
        
        @keyframes glitch {
            0% { text-shadow: 2px 0 #00ff00, -2px 0 #000; }
            5% { text-shadow: -2px 0 #000, 2px 0 #00ff00; }
            10% { text-shadow: 2px 0 #00ff00, -2px 0 #000; }
            15% { text-shadow: -2px 0 #000, 2px 0 #00ff00; }
            100% { text-shadow: 2px 0 #00ff00, -2px 0 #000; }
        }
        
        footer {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            border-top: 1px solid #00ff00;
            font-size: 0.8rem;
            color: #009900;
        }
        
        /* æ¶ˆæ¯æ“ä½œæŒ‰é’®æ ·å¼ */
        .message-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .message:hover .message-actions {
            opacity: 1;
        }
        
        .message-action {
            background: rgba(0, 30, 0, 0.7);
            border: 1px solid #00cc00;
            border-radius: 3px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            color: #00ff00;
        }
        
        .message-action:hover {
            background: rgba(0, 50, 0, 0.9);
            box-shadow: 0 0 5px #00ff00;
        }
        
        /* ç‰ˆæœ¬åˆ‡æ¢å™¨æ ·å¼ */
        .version-switcher {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
            font-size: 0.8rem;
            color: #009900;
        }
        
        .version-switcher button {
            width: auto;
            padding: 2px 8px;
            background: rgba(0, 30, 0, 0.5);
            border: 1px solid #009900;
        }
        
        .version-switcher button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                margin-bottom: 20px;
            }
            
            .chat-messages {
                max-height: 50vh;
            }
            
            .message {
                max-width: 90%;
            }
            
            .message-actions {
                opacity: 1; /* åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šå§‹ç»ˆæ˜¾ç¤ºæ“ä½œæŒ‰é’® */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="glitch-effect">DEEPSEEK CHAT</h1>
            <div class="header-subtitle">åŸºäºAPIçš„ç»ˆç«¯å¼å¯¹è¯ç•Œé¢ | æ”¯æŒæµå¼è¾“å‡º | AIåœ¨å·¦ï¼Œç”¨æˆ·åœ¨å³çš„å¾®ä¿¡å¼å¸ƒå±€</div>
        </header>
        
        <div class="main-content">
            <div class="sidebar">
                <div class="api-key-container">
                    <label for="api-key">APIå¯†é’¥:</label>
                    <input type="password" id="api-key" placeholder="è¾“å…¥æ‚¨çš„DeepSeek APIå¯†é’¥">
                    <button id="save-api-key">ä¿å­˜å¯†é’¥</button>
                </div>
                
                <div class="model-selector">
                    <label for="model">é€‰æ‹©æ¨¡å‹:</label>
                    <select id="model">
                        <option value="deepseek-chat">DeepSeek Chat</option>
                        <option value="deepseek-reasoner">DeepSeek Reasoner</option>
                    </select>
                </div>
                
                <div class="conversation-management">
                    <label>å¯¹è¯ç®¡ç†:</label>
                    <div class="btn-group">
                        <button id="new-chat">æ–°å»ºå¯¹è¯</button>
                        <button id="delete-chat">åˆ é™¤å½“å‰</button>
                    </div>
                </div>
                
                <div class="conversation-list">
                    <label>å¯¹è¯å†å²:</label>
                    <div id="conversations-container"></div>
                </div>
            </div>
            
            <div class="chat-area">
                <div class="chat-header">
                    <div id="current-conversation-title">æ–°å¯¹è¯</div>
                    <div id="current-model">deepseek-chat</div>
                </div>
                
                <div class="chat-messages" id="chat-messages">
                    <div class="message assistant-message">
                        <div class="message-header">AIåŠ©æ‰‹</div>
                        <div class="message-content">
                            DeepSeekå¯¹è¯ç»ˆç«¯å·²å¯åŠ¨ã€‚è¯·è®¾ç½®æ‚¨çš„APIå¯†é’¥å¹¶å¼€å§‹å¯¹è¯ã€‚
                            <br>ä½œè€…QQï¼š391943464
                            <br>æ–°åŠŸèƒ½ï¼šAIæ¶ˆæ¯åœ¨å·¦ä¾§ï¼Œç”¨æˆ·æ¶ˆæ¯åœ¨å³ä¾§ï¼Œç±»ä¼¼å¾®ä¿¡/QQå¸ƒå±€
                        </div>
                    </div>
                </div>
                
                <div class="input-area">
                    <textarea id="user-input" rows="3" placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯ï¼ˆæŒ‰Enteræ¢è¡Œï¼ŒæŒ‰Ctrl+Enterå‘é€ï¼‰"></textarea>
                    <button id="send-button">å‘é€æ¶ˆæ¯</button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>åŸºäºDeepSeek API | é»‘å®¢ç»ˆç«¯é£æ ¼ç•Œé¢ | æ”¯æŒæµå¼è¾“å‡º | å¯¹è¯æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°</p>
        </footer>
    </div>

    <script>
        // ä¸»è¦å˜é‡
        let apiKey = localStorage.getItem('deepseek_api_key') || '';
        let currentModel = localStorage.getItem('deepseek_model') || 'deepseek-chat';
        let conversations = JSON.parse(localStorage.getItem('deepseek_conversations') || '[]');
        let currentConversationId = localStorage.getItem('deepseek_current_conversation_id') || null;
        let isStreaming = false;
        let currentStreamController = null;
        
        // DOMå…ƒç´ 
        const apiKeyInput = document.getElementById('api-key');
        const modelSelect = document.getElementById('model');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const chatMessages = document.getElementById('chat-messages');
        const conversationsContainer = document.getElementById('conversations-container');
        const currentConversationTitle = document.getElementById('current-conversation-title');
        const currentModelElement = document.getElementById('current-model');
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®ä¿å­˜çš„å€¼
            apiKeyInput.value = apiKey;
            modelSelect.value = currentModel;
            currentModelElement.textContent = currentModel;
            
            // åŠ è½½å¯¹è¯å†å²
            loadConversations();
            
            // å¦‚æœæ²¡æœ‰å¯¹è¯ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„
            if (conversations.length === 0) {
                createNewConversation();
            } else if (currentConversationId) {
                // åŠ è½½å½“å‰å¯¹è¯
                loadConversation(currentConversationId);
            } else {
                // åŠ è½½æœ€è¿‘çš„å¯¹è¯
                loadConversation(conversations[0].id);
            }
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
        });
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // ä¿å­˜APIå¯†é’¥
            document.getElementById('save-api-key').addEventListener('click', function() {
                apiKey = apiKeyInput.value;
                localStorage.setItem('deepseek_api_key', apiKey);
                addMessage('ç³»ç»Ÿ', 'APIå¯†é’¥å·²æ›´æ–°ã€‚', 'assistant');
            });
            
            // æ¨¡å‹é€‰æ‹©
            modelSelect.addEventListener('change', function() {
                currentModel = modelSelect.value;
                localStorage.setItem('deepseek_model', currentModel);
                currentModelElement.textContent = currentModel;
                addMessage('ç³»ç»Ÿ', `æ¨¡å‹å·²åˆ‡æ¢ä¸º: ${currentModel}`, 'assistant');
            });
            
            // æ–°å»ºå¯¹è¯
            document.getElementById('new-chat').addEventListener('click', function() {
                createNewConversation();
            });
            
            // åˆ é™¤å¯¹è¯
            document.getElementById('delete-chat').addEventListener('click', function() {
                if (currentConversationId && confirm('ç¡®å®šè¦åˆ é™¤å½“å‰å¯¹è¯å—ï¼Ÿ')) {
                    deleteConversation(currentConversationId);
                }
            });
            
            // å‘é€æ¶ˆæ¯
            sendButton.addEventListener('click', sendMessage);
            
            // ä½¿ç”¨Ctrl+Enterå‘é€æ¶ˆæ¯
            userInput.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    sendMessage();
                }
            });
        }
        
        // åˆ›å»ºæ–°å¯¹è¯
        function createNewConversation() {
            const newId = 'conversation_' + Date.now();
            const newConversation = {
                id: newId,
                title: 'æ–°å¯¹è¯ ' + new Date().toLocaleTimeString(),
                model: currentModel,
                messages: [],
                createdAt: new Date().toISOString()
            };
            
            conversations.unshift(newConversation);
            saveConversations();
            loadConversation(newId);
        }
        
        // åŠ è½½å¯¹è¯åˆ—è¡¨
        function loadConversations() {
            conversationsContainer.innerHTML = '';
            
            conversations.forEach(conversation => {
                const div = document.createElement('div');
                div.className = 'conversation-item' + (conversation.id === currentConversationId ? ' active' : '');
                div.innerHTML = `
                    <div>${conversation.title}</div>
                    <div class="timestamp">${formatDate(conversation.createdAt)}</div>
                `;
                
                div.addEventListener('click', function() {
                    loadConversation(conversation.id);
                });
                
                conversationsContainer.appendChild(div);
            });
        }
        
        // åŠ è½½ç‰¹å®šå¯¹è¯
        function loadConversation(id) {
            // å¦‚æœå½“å‰æœ‰æµå¼è¾“å‡ºï¼Œä¸­æ­¢å®ƒ
            if (isStreaming && currentStreamController) {
                currentStreamController.abort();
                isStreaming = false;
            }
            
            const conversation = conversations.find(c => c.id === id);
            if (!conversation) return;
            
            currentConversationId = id;
            localStorage.setItem('deepseek_current_conversation_id', id);
            
            // æ›´æ–°UI
            currentConversationTitle.textContent = conversation.title;
            
            // æ¸…ç©ºæ¶ˆæ¯åŒºåŸŸ
            chatMessages.innerHTML = '';
            
            // æ·»åŠ æ¶ˆæ¯
            conversation.messages.forEach((msg, index) => {
                addMessage(msg.role === 'user' ? 'ç”¨æˆ·' : 'AIåŠ©æ‰‹', msg.content, msg.role, false, index);
            });
            
            // æ›´æ–°å¯¹è¯åˆ—è¡¨é«˜äº®
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.querySelectorAll('.conversation-item').forEach(item => {
                if (item.textContent.includes(conversation.title)) {
                    item.classList.add('active');
                }
            });
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            scrollToBottom();
        }
        
        // åˆ é™¤å¯¹è¯
        function deleteConversation(id) {
            const index = conversations.findIndex(c => c.id === id);
            if (index === -1) return;
            
            conversations.splice(index, 1);
            saveConversations();
            
            if (conversations.length > 0) {
                loadConversation(conversations[0].id);
            } else {
                createNewConversation();
            }
        }
        
        // ä¿å­˜å¯¹è¯åˆ°æœ¬åœ°å­˜å‚¨
        function saveConversations() {
            localStorage.setItem('deepseek_conversations', JSON.stringify(conversations));
            loadConversations();
        }
        
        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            
            if (!apiKey) {
                addMessage('ç³»ç»Ÿ', 'é”™è¯¯: è¯·å…ˆè®¾ç½®APIå¯†é’¥', 'assistant');
                return;
            }
            
            // è·å–å½“å‰å¯¹è¯
            const conversation = conversations.find(c => c.id === currentConversationId);
            if (!conversation) return;
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°UI
            const userMessageIndex = conversation.messages.length;
            addMessage('ç”¨æˆ·', message, 'user', false, userMessageIndex);
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å¯¹è¯å†å²
            conversation.messages.push({ 
                role: 'user', 
                content: message,
                versions: [message], // ç”¨æˆ·æ¶ˆæ¯é€šå¸¸åªæœ‰ä¸€ä¸ªç‰ˆæœ¬
                currentVersion: 0
            });
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            userInput.value = '';
            
            // ä¿å­˜å¯¹è¯
            saveConversations();
            
            try {
                // å‡†å¤‡è¯·æ±‚æ•°æ®
                const requestData = {
                    model: currentModel,
                    messages: conversation.messages.map(msg => ({
                        role: msg.role,
                        content: msg.versions[msg.currentVersion]
                    })),
                    stream: true,  // å¯ç”¨æµå¼è¾“å‡º
                    temperature: 0.7,
                    max_tokens: 2048
                };
                
                // æ˜¾ç¤º"æ­£åœ¨è¾“å…¥"æ¶ˆæ¯
                const assistantMessageIndex = conversation.messages.length;
                const typingIndicator = addMessage('AIåŠ©æ‰‹', '', 'assistant', true, assistantMessageIndex);
                
                // åˆ›å»ºAbortControllerä»¥ä¾¿å¯ä»¥ä¸­æ­¢è¯·æ±‚
                const controller = new AbortController();
                currentStreamController = controller;
                isStreaming = true;
                
                // å‘é€è¯·æ±‚åˆ°DeepSeek API
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData),
                    signal: controller.signal
                });
                
                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                }
                
                // å¤„ç†æµå¼å“åº”
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    // è§£ç æµæ•°æ®
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') {
                                isStreaming = false;
                                break;
                            }
                            
                            try {
                                const parsed = JSON.parse(data);
                                const content = parsed.choices[0]?.delta?.content || '';
                                if (content) {
                                    fullResponse += content;
                                    updateMessage(typingIndicator, fullResponse + '<span class="typing-indicator"></span>');
                                    scrollToBottom();
                                }
                            } catch (e) {
                                console.error('è§£ææµæ•°æ®é”™è¯¯:', e);
                            }
                        }
                    }
                }
                
                // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨
                updateMessage(typingIndicator, fullResponse);
                
                // æ·»åŠ åŠ©æ‰‹æ¶ˆæ¯åˆ°å¯¹è¯å†å²
                conversation.messages.push({ 
                    role: 'assistant', 
                    content: fullResponse,
                    versions: [fullResponse], // åˆå§‹ç‰ˆæœ¬
                    currentVersion: 0
                });
                
                // æ›´æ–°å¯¹è¯æ ‡é¢˜ï¼ˆå¦‚æœæ˜¯æ–°å¯¹è¯ä¸”ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼‰
                if (conversation.messages.length === 2) {
                    conversation.title = message.length > 20 ? message.substring(0, 20) + '...' : message;
                    currentConversationTitle.textContent = conversation.title;
                }
                
                // ä¿å­˜å¯¹è¯
                saveConversations();
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    addMessage('ç³»ç»Ÿ', 'è¯·æ±‚å·²ä¸­æ­¢', 'assistant');
                } else {
                    // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨
                    if (typingIndicator && typingIndicator.parentNode) {
                        chatMessages.removeChild(typingIndicator);
                    }
                    
                    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                    addMessage('ç³»ç»Ÿ', `é”™è¯¯: ${error.message}`, 'assistant');
                    
                    // ä»å¯¹è¯å†å²ä¸­ç§»é™¤ç”¨æˆ·æ¶ˆæ¯ï¼ˆå› ä¸ºè¯·æ±‚å¤±è´¥ï¼‰
                    conversation.messages.pop();
                    saveConversations();
                }
            } finally {
                isStreaming = false;
                currentStreamController = null;
            }
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
        function addMessage(role, content, type, isTyping = false, messageIndex = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            messageDiv.setAttribute('data-message-index', messageIndex);
            
            // åˆ›å»ºæ¶ˆæ¯æ“ä½œæŒ‰é’®
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'message-actions';
            
            // æ·»åŠ åˆ é™¤æŒ‰é’®ï¼ˆåƒåœ¾æ¡¶å›¾æ ‡ï¼‰
            const deleteButton = document.createElement('button');
            deleteButton.className = 'message-action';
            deleteButton.innerHTML = 'ğŸ—‘ï¸';
            deleteButton.title = 'åˆ é™¤æ­¤æ¶ˆæ¯';
            deleteButton.addEventListener('click', function() {
                deleteSingleMessage(messageIndex);
            });
            actionsDiv.appendChild(deleteButton);
            
            // å¦‚æœæ˜¯AIæ¶ˆæ¯ï¼Œæ·»åŠ é‡æ–°ç”ŸæˆæŒ‰é’®
            if (type === 'assistant') {
                const regenerateButton = document.createElement('button');
                regenerateButton.className = 'message-action';
                regenerateButton.innerHTML = 'ğŸ”„';
                regenerateButton.title = 'é‡æ–°ç”Ÿæˆç­”æ¡ˆ';
                regenerateButton.addEventListener('click', function() {
                    regenerateAnswer(messageIndex);
                });
                actionsDiv.appendChild(regenerateButton);
            }
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span>${role}</span>
                </div>
                <div class="message-content">${isTyping ? '<span class="typing-indicator"></span>' : content}</div>
            `;
            
            // å¦‚æœæ˜¯AIæ¶ˆæ¯ä¸”æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œæ·»åŠ ç‰ˆæœ¬åˆ‡æ¢å™¨
            if (type === 'assistant' && messageIndex !== null) {
                const conversation = conversations.find(c => c.id === currentConversationId);
                if (conversation && conversation.messages[messageIndex]) {
                    const msg = conversation.messages[messageIndex];
                    if (msg.versions && msg.versions.length > 1) {
                        const versionSwitcher = document.createElement('div');
                        versionSwitcher.className = 'version-switcher';
                        versionSwitcher.innerHTML = `
                            <button class="version-prev" ${msg.currentVersion === 0 ? 'disabled' : ''}>â—€</button>
                            <span>ç‰ˆæœ¬ ${msg.currentVersion + 1}/${msg.versions.length}</span>
                            <button class="version-next" ${msg.currentVersion === msg.versions.length - 1 ? 'disabled' : ''}>â–¶</button>
                        `;
                        
                        // æ·»åŠ ç‰ˆæœ¬åˆ‡æ¢äº‹ä»¶
                        const prevButton = versionSwitcher.querySelector('.version-prev');
                        const nextButton = versionSwitcher.querySelector('.version-next');
                        
                        prevButton.addEventListener('click', function() {
                            if (msg.currentVersion > 0) {
                                msg.currentVersion--;
                                updateMessageVersion(messageDiv, msg.versions[msg.currentVersion], msg.currentVersion, msg.versions.length);
                                saveConversations();
                            }
                        });
                        
                        nextButton.addEventListener('click', function() {
                            if (msg.currentVersion < msg.versions.length - 1) {
                                msg.currentVersion++;
                                updateMessageVersion(messageDiv, msg.versions[msg.currentVersion], msg.currentVersion, msg.versions.length);
                                saveConversations();
                            }
                        });
                        
                        messageDiv.appendChild(versionSwitcher);
                    }
                }
            }
            
            messageDiv.appendChild(actionsDiv);
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
            
            return messageDiv;
        }
        
        // æ›´æ–°æ¶ˆæ¯å†…å®¹
        function updateMessage(messageElement, content) {
            const contentElement = messageElement.querySelector('.message-content');
            contentElement.innerHTML = content;
        }
        
        // æ›´æ–°æ¶ˆæ¯ç‰ˆæœ¬æ˜¾ç¤º
        function updateMessageVersion(messageElement, content, currentVersion, totalVersions) {
            const contentElement = messageElement.querySelector('.message-content');
            contentElement.innerHTML = content;
            
            // æ›´æ–°ç‰ˆæœ¬åˆ‡æ¢å™¨
            const versionSwitcher = messageElement.querySelector('.version-switcher');
            if (versionSwitcher) {
                versionSwitcher.innerHTML = `
                    <button class="version-prev" ${currentVersion === 0 ? 'disabled' : ''}>â—€</button>
                    <span>ç‰ˆæœ¬ ${currentVersion + 1}/${totalVersions}</span>
                    <button class="version-next" ${currentVersion === totalVersions - 1 ? 'disabled' : ''}>â–¶</button>
                `;
                
                // é‡æ–°ç»‘å®šäº‹ä»¶
                const prevButton = versionSwitcher.querySelector('.version-prev');
                const nextButton = versionSwitcher.querySelector('.version-next');
                const messageIndex = parseInt(messageElement.getAttribute('data-message-index'));
                
                prevButton.addEventListener('click', function() {
                    const conversation = conversations.find(c => c.id === currentConversationId);
                    if (conversation && conversation.messages[messageIndex]) {
                        const msg = conversation.messages[messageIndex];
                        if (msg.currentVersion > 0) {
                            msg.currentVersion--;
                            updateMessageVersion(messageElement, msg.versions[msg.currentVersion], msg.currentVersion, msg.versions.length);
                            saveConversations();
                        }
                    }
                });
                
                nextButton.addEventListener('click', function() {
                    const conversation = conversations.find(c => c.id === currentConversationId);
                    if (conversation && conversation.messages[messageIndex]) {
                        const msg = conversation.messages[messageIndex];
                        if (msg.currentVersion < msg.versions.length - 1) {
                            msg.currentVersion++;
                            updateMessageVersion(messageElement, msg.versions[msg.currentVersion], msg.currentVersion, msg.versions.length);
                            saveConversations();
                        }
                    }
                });
            }
        }
        
        // åˆ é™¤å•æ¡æ¶ˆæ¯
        function deleteSingleMessage(messageIndex) {
            if (messageIndex === null || messageIndex === undefined) return;
            
            const conversation = conversations.find(c => c.id === currentConversationId);
            if (!conversation || !conversation.messages[messageIndex]) return;
            
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
                // åˆ é™¤è¯¥æ¶ˆæ¯åŠä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯
                conversation.messages.splice(messageIndex);
                
                // ä¿å­˜å¹¶é‡æ–°åŠ è½½å¯¹è¯
                saveConversations();
                loadConversation(currentConversationId);
            }
        }
        
        // é‡æ–°ç”Ÿæˆç­”æ¡ˆ
        async function regenerateAnswer(messageIndex) {
            if (messageIndex === null || messageIndex === undefined) return;
            
            const conversation = conversations.find(c => c.id === currentConversationId);
            if (!conversation || !conversation.messages[messageIndex]) return;
            
            // ç¡®ä¿è¿™æ˜¯AIæ¶ˆæ¯
            if (conversation.messages[messageIndex].role !== 'assistant') return;
            
            // æ‰¾åˆ°å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯
            if (messageIndex === 0) return; // ç¬¬ä¸€æ¡æ¶ˆæ¯ä¸èƒ½æ˜¯AIæ¶ˆæ¯
            
            const userMessage = conversation.messages[messageIndex - 1];
            if (!userMessage || userMessage.role !== 'user') return;
            
            if (!apiKey) {
                addMessage('ç³»ç»Ÿ', 'é”™è¯¯: è¯·å…ˆè®¾ç½®APIå¯†é’¥', 'assistant');
                return;
            }
            
            try {
                // å‡†å¤‡è¯·æ±‚æ•°æ®ï¼ˆåªåŒ…å«åˆ°ç”¨æˆ·æ¶ˆæ¯ä¸ºæ­¢çš„ä¸Šä¸‹æ–‡ï¼‰
                const messagesToSend = conversation.messages.slice(0, messageIndex).map(msg => ({
                    role: msg.role,
                    content: msg.versions[msg.currentVersion]
                }));
                
                const requestData = {
                    model: currentModel,
                    messages: messagesToSend,
                    stream: true,
                    temperature: 0.7,
                    max_tokens: 2048
                };
                
                // æ˜¾ç¤º"æ­£åœ¨è¾“å…¥"æ¶ˆæ¯
                const typingIndicator = addMessage('AIåŠ©æ‰‹', '', 'assistant', true, messageIndex);
                
                // åˆ›å»ºAbortControllerä»¥ä¾¿å¯ä»¥ä¸­æ­¢è¯·æ±‚
                const controller = new AbortController();
                currentStreamController = controller;
                isStreaming = true;
                
                // å‘é€è¯·æ±‚åˆ°DeepSeek API
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData),
                    signal: controller.signal
                });
                
                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                }
                
                // å¤„ç†æµå¼å“åº”
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    // è§£ç æµæ•°æ®
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') {
                                isStreaming = false;
                                break;
                            }
                            
                            try {
                                const parsed = JSON.parse(data);
                                const content = parsed.choices[0]?.delta?.content || '';
                                if (content) {
                                    fullResponse += content;
                                    updateMessage(typingIndicator, fullResponse + '<span class="typing-indicator"></span>');
                                    scrollToBottom();
                                }
                            } catch (e) {
                                console.error('è§£ææµæ•°æ®é”™è¯¯:', e);
                            }
                        }
                    }
                }
                
                // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨
                updateMessage(typingIndicator, fullResponse);
                
                // å°†æ–°ç­”æ¡ˆæ·»åŠ åˆ°ç°æœ‰AIæ¶ˆæ¯çš„ç‰ˆæœ¬ä¸­
                if (!conversation.messages[messageIndex].versions) {
                    conversation.messages[messageIndex].versions = [conversation.messages[messageIndex].content];
                }
                
                conversation.messages[messageIndex].versions.push(fullResponse);
                conversation.messages[messageIndex].currentVersion = conversation.messages[messageIndex].versions.length - 1;
                
                // åˆ é™¤è¯¥AIæ¶ˆæ¯ä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯
                conversation.messages.splice(messageIndex + 1);
                
                // ä¿å­˜å¯¹è¯
                saveConversations();
                
                // é‡æ–°åŠ è½½å¯¹è¯ä»¥æ›´æ–°ç‰ˆæœ¬åˆ‡æ¢å™¨
                loadConversation(currentConversationId);
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    addMessage('ç³»ç»Ÿ', 'è¯·æ±‚å·²ä¸­æ­¢', 'assistant');
                } else {
                    // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨
                    if (typingIndicator && typingIndicator.parentNode) {
                        chatMessages.removeChild(typingIndicator);
                    }
                    
                    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                    addMessage('ç³»ç»Ÿ', `é”™è¯¯: ${error.message}`, 'assistant');
                }
            } finally {
                isStreaming = false;
                currentStreamController = null;
            }
        }
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString().slice(0, 5);
        }
    </script>
</body>
</html>
